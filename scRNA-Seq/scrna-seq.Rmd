# Load libraries
```{R, warning=F, message=F}
library(Seurat)
library(patchwork)
library(dplyr)
```

# Set up connection to seurat directory
```{R}
pbmc.data <- Read10X(data.dir = "~/scRNA-Seq/seurat/")
```


# Create Seurat Object
Filtering is applied in this step, where we can select:
* include features (genes) detected in at least n cells (min.cells)
* include cells where at least n features are detected (min.features)

For the tutorial we will select conservative filtering values. 
```{R}
pbmc <- CreateSeuratObject(counts = pbmc.data, project = "pbmc1k", min.cells = 2, min.features = 100)
pbmc
```


# Standard pre-processing workflow
In this step we want to remove low quality cells with very few genes, or exclude cells with an abberantly high count. 
Furthermore, we will use the fraction of mitochondrial genes present in a cell as a proxy for cell quality.
(Low qual/dying cells often exhibit mitochondrial contamination)

# Append mitochondrial fraction to each cell
This can be acessed using pbmc$percent.mt
```{R}
pbmc[["percent.mt"]] <- PercentageFeatureSet(pbmc, pattern = "^MT-")
```


# Violin plot of cell features + mitochondrial features. 
```{R}
VlnPlot(pbmc, features = c("nFeature_RNA", "percent.mt"), ncol = 2)
```

# Scatter plot
x-axis represents number of cells. 
```{R}
plot1 <- FeatureScatter(pbmc, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(pbmc, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1 + plot2
```


# Apply filtering to the pbmc object 
We will remove cells with gene counts below 100, and remove cells with mitochondrial percentage above 10%. 
```{R}
pbmc <- subset(pbmc, subset = nFeature_RNA > 20 & percent.mt < 10)
```


# Normalisation
after removing poor quality cells per mitochondrial gene fraction, we will normalise the dataset using 'LogNormalize'
```{R}
pbmc <- NormalizeData(pbmc, normalization.method = "LogNormalize", scale.factor = 10000)
```

# Identfy highly variable features
Subset features that exhibit high cell-to-cell variation.
```{R}
pbmc <- FindVariableFeatures(pbmc, selection.method = "vst", nfeatures = 2000)

# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(pbmc), 10)

# plot variable features with and without labels
plot1 <- VariableFeaturePlot(pbmc)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot2
```

# Scale the data
Scaling is required before conducting PCA.
```{R}
all.genes <- rownames(pbmc)
pbmc <- ScaleData(pbmc, features = all.genes)
```

# PCA
```{R}
pbmc <- RunPCA(pbmc, features = VariableFeatures(object = pbmc), npcs = 15)
```

# Plot loadings 
```{R}
VizDimLoadings(pbmc, dims = 1:2, reduction = "pca")
```

# Dimension Reduction plot
Graphs the output of a dimensional reduction technique on a 2D scatter plot where each point is a cell and it's positioned based on the cell embeddings determined by the reduction technique.
```{R}
DimPlot(pbmc, reduction = "pca")
```

# Dimension Reduction Heatmap
```{R}
DimHeatmap(pbmc, dims = 1:15, cells = 500, balanced = TRUE)
```

# Determine PCs to include in downstream analysis
```{R}
pbmc <- JackStraw(pbmc, num.replicate = 100)
pbmc <- ScoreJackStraw(pbmc, dims = 1:15)
```

# JackStrawPlot plots pvalues for each PC. 
```{R}
JackStrawPlot(pbmc, dims = 1:15)
```

# Elbow Plot
```{R}
ElbowPlot(pbmc)
```

# Clustering
```{R}
pbmc <- FindNeighbors(pbmc, dims = 1:12)
pbmc <- FindClusters(pbmc, resolution = 0.5)
```

# UMAP
```{R}
pbmc <- RunUMAP(pbmc, dims = 1:10)
```

```{R}
DimPlot(pbmc, reduction = "umap")
```


# DE genes
```{R}
# find all markers of cluster 1
cluster1.markers <- FindMarkers(pbmc, ident.1 = 1, min.pct = 0.25)
head(cluster1.markers, n = 5)
```

```{R}
# find all markers distinguishing cluster 5 from clusters 0 and 3
cluster5.markers <- FindMarkers(pbmc, ident.1 = 5, ident.2 = c(0, 3), min.pct = 0.25)
head(cluster5.markers, n = 5)
```

```{r}
# find markers for every cluster compared to all remaining cells, report only the positive ones
pbmc.markers <- FindAllMarkers(pbmc, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
pbmc.markers %>% group_by(cluster) %>% top_n(n = 2, wt = avg_logFC)
```

```{R}
VlnPlot(pbmc, features = c("CCNB2P1", "IGKC"))
```


```{R}
FeaturePlot(pbmc, features = c("SLAIN1", "PIGBOS1", "S100A8", "CCNB2P1", "LGALS2", "HLA-DRA.6"))
```

```{R}
new.cluster.ids <- c("Naive CD4 T", "Memory CD4 T", "CD14+ Mono", "B", "CD8 T", "FCGR3A+ Mono", 
    "NK", "DC", "Platelet")
names(new.cluster.ids) <- levels(pbmc)
pbmc <- RenameIdents(pbmc, new.cluster.ids)
DimPlot(pbmc, reduction = "umap", label = TRUE, pt.size = 0.5) + NoLegend()
```